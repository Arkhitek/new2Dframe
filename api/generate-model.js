// å¿…è¦ãªãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’èª­ã¿è¾¼ã‚€
const express = require('express');
const https = require('https');
require('dotenv').config({ path: '../.env' }); // ãƒ«ãƒ¼ãƒˆã®.envãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚€

// Expressã®ãƒ«ãƒ¼ã‚¿ãƒ¼ã‚’ä½œæˆ
const router = express.Router();

// Mistral AI APIã®è¨­å®š
const MISTRAL_API_KEY = process.env.MISTRAL_API_KEY || 'FjuAEorphVEPBIjqJVLagjfqlFYyRzFC';
const MISTRAL_API_URL = 'https://api.mistral.ai/v1/chat/completions';

// POSTãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å‡¦ç†ã™ã‚‹éƒ¨åˆ†
router.post('/', async (req, res) => {
    try {
        const { prompt: userPrompt, mode = 'new', currentModel } = req.body;
        if (!userPrompt) {
            return res.status(400).json({ error: 'æŒ‡ç¤ºå†…å®¹ãŒç©ºã§ã™ã€‚' });
        }
        
        const API_KEY = process.env.MISTRAL_API_KEY || 'FjuAEorphVEPBIjqJVLagjfqlFYyRzFC';
        if (!API_KEY) {
            throw new Error("Mistral AI APIã®ã‚­ãƒ¼ãŒã‚µãƒ¼ãƒãƒ¼ã«è¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚");
        }

         // APIã‚­ãƒ¼ã®æœ‰åŠ¹æ€§ã‚’ç¢ºèªï¼ˆç°¡æ½”ã«ï¼‰
         console.log('ğŸ”‘ Mistral AI APIã‚­ãƒ¼è¨­å®šæ¸ˆã¿:', API_KEY ? 'Yes' : 'No');

        // OpenAI APIã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡
        const systemPrompt = createSystemPromptForBackend(mode, currentModel);
        let userMessage = userPrompt;
        if (mode === 'edit' && currentModel) {
            userMessage = createEditPrompt(userPrompt, currentModel);
        }

        console.log('ğŸ¤– Mistral AI APIã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ä¸­...');
        
         // Mistral AI APIã®ã¿ã‚’ä½¿ç”¨ï¼ˆãƒ¢ãƒƒã‚¯æ©Ÿèƒ½ã¯å®Œå…¨ã«ç„¡åŠ¹åŒ–ï¼‰
         console.log('ğŸ¤– Mistral AI APIã®ã¿ã‚’ä½¿ç”¨ã—ã¾ã™ï¼ˆãƒ¢ãƒƒã‚¯æ©Ÿèƒ½ç„¡åŠ¹ï¼‰');
         
         // ã‚ˆã‚ŠåŠ¹ç‡çš„ãªãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç”Ÿæˆ
         const efficientPrompt = createEfficientPrompt(userPrompt, mode, currentModel);
         
         // Mistral AI APIã«ç›´æ¥HTTPãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡
         const requestData = JSON.stringify({
             model: "mistral-small-latest",
             messages: [
                 {
                     role: "system",
                     content: efficientPrompt
                 },
                 {
                     role: "user",
                     content: userPrompt
                 }
             ],
             temperature: 0.1,
             max_tokens: 2000, // Increased for complex multi-span structures
             top_p: 0.7
         });

         const completion = await new Promise((resolve, reject) => {
             const options = {
                 hostname: 'api.mistral.ai',
                 port: 443,
                 path: '/v1/chat/completions',
                 method: 'POST',
                 headers: {
                     'Content-Type': 'application/json',
                     'Authorization': `Bearer ${MISTRAL_API_KEY}`,
                     'Content-Length': Buffer.byteLength(requestData)
                 }
             };

             const req = https.request(options, (res) => {
                 let data = '';
                 res.on('data', (chunk) => {
                     data += chunk;
                 });
                 res.on('end', () => {
                     try {
                         const result = JSON.parse(data);
                         if (res.statusCode !== 200) {
                             reject(new Error(`Mistral AI APIã‚¨ãƒ©ãƒ¼: ${res.statusCode} ${res.statusMessage}`));
                         } else {
                             resolve(result);
                         }
                     } catch (error) {
                         reject(new Error('ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®è§£æã«å¤±æ•—ã—ã¾ã—ãŸ'));
                     }
                 });
             });

             req.on('error', (error) => {
                 reject(new Error(`ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: ${error.message}`));
             });

            req.setTimeout(60000, () => { // Increased to 60 seconds for complex structures
                req.destroy();
                reject(new Error('ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆï¼ˆ60ç§’ï¼‰'));
            });

             req.write(requestData);
             req.end();
         });

         if (!completion.choices || completion.choices.length === 0) {
             throw new Error("Mistral AIã‹ã‚‰äºˆæœŸã—ãªã„å½¢å¼ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒã‚ã‚Šã¾ã—ãŸã€‚");
         }

         const generatedText = completion.choices[0].message.content;
         console.log('âœ… Mistral AI APIã‹ã‚‰ã®å¿œç­”ã‚’å—ä¿¡ã—ã¾ã—ãŸ');

         // ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ãŒæœŸå¾…ã™ã‚‹ãƒ¬ã‚¹ãƒãƒ³ã‚¹å½¢å¼ã«åˆã‚ã›ã‚‹
         const responseForFrontend = {
             candidates: [{
                 content: {
                     parts: [{ text: generatedText }]
                 }
             }]
         };

         res.status(200).json(responseForFrontend);
         return;

    } catch (error) {
        console.error('APIãƒ«ãƒ¼ãƒˆã‚¨ãƒ©ãƒ¼:', error);
        let errorMessage = 'AIãƒ¢ãƒ‡ãƒ«ã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚';
        
               if (error.message.includes('quota') || error.message.includes('billing') || error.message.includes('exceeded')) {
                   errorMessage = 'Mistral AI APIã®ã‚¯ã‚©ãƒ¼ã‚¿åˆ¶é™ã«é”ã—ã¾ã—ãŸã€‚APIã‚­ãƒ¼ã®ä½¿ç”¨é‡ã‚’ç¢ºèªã™ã‚‹ã‹ã€æ–°ã—ã„APIã‚­ãƒ¼ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚';
               } else if (error.message.includes('429') || error.message.includes('Too Many Requests')) {
                   errorMessage = 'APIã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆåˆ¶é™ã«é”ã—ã¾ã—ãŸã€‚ã—ã°ã‚‰ãå¾…ã£ã¦ã‹ã‚‰å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚';
               } else if (error.message.includes('ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ') || error.message.includes('timeout')) {
                   errorMessage = 'APIã®å¿œç­”ãŒé…ã„ãŸã‚ã€ã‚ˆã‚Šç°¡å˜ãªæ§‹é€ ã§å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚';
               } else if (error.message.includes('SAFETY')) {
                   errorMessage = 'å®‰å…¨æ€§ã®è¨­å®šã«ã‚ˆã‚Šã€å¿œç­”ãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¾ã—ãŸã€‚ã‚ˆã‚Šä¸€èˆ¬çš„ãªè¡¨ç¾ã§è©¦ã—ã¦ãã ã•ã„ã€‚';
               } else if (error instanceof SyntaxError) {
                    errorMessage = 'AIã‹ã‚‰ã®å¿œç­”ãŒä¸æ­£ãªå½¢å¼ã§ã—ãŸã€‚å°‘ã—è¡¨ç¾ã‚’å¤‰ãˆã¦å†åº¦è©¦ã—ã¦ãã ã•ã„ã€‚';
               } else {
                   errorMessage = error.message;
               }
               
               // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯æ©Ÿèƒ½: 2ã‚¹ãƒ‘ãƒ³æ§‹é€ ã®å ´åˆã¯åŸºæœ¬çš„ãªæ§‹é€ ã‚’æä¾›
               if (userPrompt.includes('2ã‚¹ãƒ‘ãƒ³') || userPrompt.includes('2span')) {
                   console.log('ğŸ”„ ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯æ©Ÿèƒ½: 2ã‚¹ãƒ‘ãƒ³æ§‹é€ ã‚’ç”Ÿæˆã—ã¾ã™');
                   const fallbackModel = generateFallback2SpanFrame();
                   const responseForFrontend = {
                       candidates: [{
                           content: {
                               parts: [{ text: JSON.stringify(fallbackModel) }]
                           }
                       }]
                   };
                   res.status(200).json(responseForFrontend);
                   return;
               }
               
        res.status(500).json({ error: errorMessage });
    }
});

// ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ `module.exports` ã¨ã—ã¦ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
module.exports = router;

// ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯æ©Ÿèƒ½: 2ã‚¹ãƒ‘ãƒ³æ§‹é€ ã‚’ç”Ÿæˆ
function generateFallback2SpanFrame() {
    return {
        nodes: [
            {"x": 0, "y": 0, "s": "x"},   // å·¦ç«¯æŸ±è„š
            {"x": 6, "y": 0, "s": "x"},   // ä¸­å¤®æŸ±è„š
            {"x": 12, "y": 0, "s": "x"},  // å³ç«¯æŸ±è„š
            {"x": 0, "y": 3, "s": "f"},   // 1å±¤å·¦ç«¯
            {"x": 6, "y": 3, "s": "f"},   // 1å±¤ä¸­å¤®
            {"x": 12, "y": 3, "s": "f"},  // 1å±¤å³ç«¯
            {"x": 0, "y": 6, "s": "f"},   // 2å±¤å·¦ç«¯
            {"x": 6, "y": 6, "s": "f"},   // 2å±¤ä¸­å¤®
            {"x": 12, "y": 6, "s": "f"},  // 2å±¤å³ç«¯
            {"x": 0, "y": 9, "s": "f"},   // 3å±¤å·¦ç«¯
            {"x": 6, "y": 9, "s": "f"},   // 3å±¤ä¸­å¤®
            {"x": 12, "y": 9, "s": "f"},  // 3å±¤å³ç«¯
            {"x": 0, "y": 12, "s": "f"},  // 4å±¤å·¦ç«¯
            {"x": 6, "y": 12, "s": "f"},  // 4å±¤ä¸­å¤®
            {"x": 12, "y": 12, "s": "f"}, // 4å±¤å³ç«¯
            {"x": 0, "y": 15, "s": "f"},  // 5å±¤å·¦ç«¯
            {"x": 6, "y": 15, "s": "f"},  // 5å±¤ä¸­å¤®
            {"x": 12, "y": 15, "s": "f"}  // 5å±¤å³ç«¯
        ],
        members: [
            // æŸ±ï¼ˆç¸¦æ–¹å‘ï¼‰
            {"i": 1, "j": 4, "E": 205000, "I": 0.00011, "A": 0.005245, "Z": 0.000638},
            {"i": 2, "j": 5, "E": 205000, "I": 0.00011, "A": 0.005245, "Z": 0.000638},
            {"i": 3, "j": 6, "E": 205000, "I": 0.00011, "A": 0.005245, "Z": 0.000638},
            {"i": 4, "j": 7, "E": 205000, "I": 0.00011, "A": 0.005245, "Z": 0.000638},
            {"i": 5, "j": 8, "E": 205000, "I": 0.00011, "A": 0.005245, "Z": 0.000638},
            {"i": 6, "j": 9, "E": 205000, "I": 0.00011, "A": 0.005245, "Z": 0.000638},
            {"i": 7, "j": 10, "E": 205000, "I": 0.00011, "A": 0.005245, "Z": 0.000638},
            {"i": 8, "j": 11, "E": 205000, "I": 0.00011, "A": 0.005245, "Z": 0.000638},
            {"i": 9, "j": 12, "E": 205000, "I": 0.00011, "A": 0.005245, "Z": 0.000638},
            {"i": 10, "j": 13, "E": 205000, "I": 0.00011, "A": 0.005245, "Z": 0.000638},
            {"i": 11, "j": 14, "E": 205000, "I": 0.00011, "A": 0.005245, "Z": 0.000638},
            {"i": 12, "j": 15, "E": 205000, "I": 0.00011, "A": 0.005245, "Z": 0.000638},
            {"i": 13, "j": 16, "E": 205000, "I": 0.00011, "A": 0.005245, "Z": 0.000638},
            {"i": 14, "j": 17, "E": 205000, "I": 0.00011, "A": 0.005245, "Z": 0.000638},
            {"i": 15, "j": 18, "E": 205000, "I": 0.00011, "A": 0.005245, "Z": 0.000638},
            // æ¢ï¼ˆæ¨ªæ–¹å‘ï¼‰
            {"i": 4, "j": 5, "E": 205000, "I": 0.00011, "A": 0.005245, "Z": 0.000638},
            {"i": 5, "j": 6, "E": 205000, "I": 0.00011, "A": 0.005245, "Z": 0.000638},
            {"i": 7, "j": 8, "E": 205000, "I": 0.00011, "A": 0.005245, "Z": 0.000638},
            {"i": 8, "j": 9, "E": 205000, "I": 0.00011, "A": 0.005245, "Z": 0.000638},
            {"i": 10, "j": 11, "E": 205000, "I": 0.00011, "A": 0.005245, "Z": 0.000638},
            {"i": 11, "j": 12, "E": 205000, "I": 0.00011, "A": 0.005245, "Z": 0.000638},
            {"i": 13, "j": 14, "E": 205000, "I": 0.00011, "A": 0.005245, "Z": 0.000638},
            {"i": 14, "j": 15, "E": 205000, "I": 0.00011, "A": 0.005245, "Z": 0.000638},
            {"i": 16, "j": 17, "E": 205000, "I": 0.00011, "A": 0.005245, "Z": 0.000638},
            {"i": 17, "j": 18, "E": 205000, "I": 0.00011, "A": 0.005245, "Z": 0.000638}
        ]
    };
}


// åŠ¹ç‡çš„ãªãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç”Ÿæˆé–¢æ•°ï¼ˆã‚¯ã‚©ãƒ¼ã‚¿åˆ¶é™å›é¿ç”¨ï¼‰
function createEfficientPrompt(userPrompt, mode = 'new', currentModel = null) {
    let prompt = `2Dãƒ•ãƒ¬ãƒ¼ãƒ æ§‹é€ è§£æãƒ¢ãƒ‡ãƒ«ã‚’ç”Ÿæˆã™ã‚‹AIã§ã™ã€‚`;

    if (mode === 'edit') {
        prompt += `æ—¢å­˜ãƒ¢ãƒ‡ãƒ«ã‚’ç·¨é›†ã—ã¾ã™ã€‚`;
    } else {
        prompt += `æ–°ã—ã„æ§‹é€ ãƒ¢ãƒ‡ãƒ«ã‚’ä½œæˆã—ã¾ã™ã€‚`;
    }

       prompt += `ä»¥ä¸‹ã®JSONå½¢å¼ã§å‡ºåŠ›ã—ã¦ãã ã•ã„ï¼ˆèª¬æ˜ãªã—ã€å®Œå…¨ãªJSONã®ã¿ï¼‰:

       **é‡è¦: ã‚¹ãƒ‘ãƒ³æ•°ã«æ³¨æ„**
       - 1ã‚¹ãƒ‘ãƒ³ = 2åˆ—ã®æŸ±ï¼ˆå·¦ç«¯ã€å³ç«¯ï¼‰
       - 2ã‚¹ãƒ‘ãƒ³ = 3åˆ—ã®æŸ±ï¼ˆå·¦ç«¯ã€ä¸­å¤®ã€å³ç«¯ï¼‰
       - 3ã‚¹ãƒ‘ãƒ³ = 4åˆ—ã®æŸ±ï¼ˆå·¦ç«¯ã€ä¸­å¤®1ã€ä¸­å¤®2ã€å³ç«¯ï¼‰`

       **å˜ç´”æ¢:**
       {"nodes":[{"x":0,"y":0,"s":"p"},{"x":8,"y":0,"s":"p"}],"members":[{"i":1,"j":2,"E":205000,"I":0.00011,"A":0.005245,"Z":0.000638}]}

       **2å±¤ãƒ©ãƒ¼ãƒ¡ãƒ³:**
       {"nodes":[{"x":0,"y":0,"s":"x"},{"x":6,"y":0,"s":"x"},{"x":0,"y":3,"s":"f"},{"x":6,"y":3,"s":"f"},{"x":0,"y":6,"s":"f"},{"x":6,"y":6,"s":"f"}],"members":[{"i":1,"j":3,"E":205000,"I":0.00011,"A":0.005245,"Z":0.000638},{"i":2,"j":4,"E":205000,"I":0.00011,"A":0.005245,"Z":0.000638},{"i":3,"j":5,"E":205000,"I":0.00011,"A":0.005245,"Z":0.000638},{"i":4,"j":6,"E":205000,"I":0.00011,"A":0.005245,"Z":0.000638},{"i":3,"j":4,"E":205000,"I":0.00011,"A":0.005245,"Z":0.000638},{"i":5,"j":6,"E":205000,"I":0.00011,"A":0.005245,"Z":0.000638}]}

       **5å±¤ãƒ©ãƒ¼ãƒ¡ãƒ³:**
       {"nodes":[{"x":0,"y":0,"s":"x"},{"x":6,"y":0,"s":"x"},{"x":0,"y":3,"s":"f"},{"x":6,"y":3,"s":"f"},{"x":0,"y":6,"s":"f"},{"x":6,"y":6,"s":"f"},{"x":0,"y":9,"s":"f"},{"x":6,"y":9,"s":"f"},{"x":0,"y":12,"s":"f"},{"x":6,"y":12,"s":"f"},{"x":0,"y":15,"s":"f"},{"x":6,"y":15,"s":"f"}],"members":[{"i":1,"j":3,"E":205000,"I":0.00011,"A":0.005245,"Z":0.000638},{"i":2,"j":4,"E":205000,"I":0.00011,"A":0.005245,"Z":0.000638},{"i":3,"j":5,"E":205000,"I":0.00011,"A":0.005245,"Z":0.000638},{"i":4,"j":6,"E":205000,"I":0.00011,"A":0.005245,"Z":0.000638},{"i":5,"j":7,"E":205000,"I":0.00011,"A":0.005245,"Z":0.000638},{"i":6,"j":8,"E":205000,"I":0.00011,"A":0.005245,"Z":0.000638},{"i":7,"j":9,"E":205000,"I":0.00011,"A":0.005245,"Z":0.000638},{"i":8,"j":10,"E":205000,"I":0.00011,"A":0.005245,"Z":0.000638},{"i":9,"j":11,"E":205000,"I":0.00011,"A":0.005245,"Z":0.000638},{"i":10,"j":12,"E":205000,"I":0.00011,"A":0.005245,"Z":0.000638},{"i":3,"j":4,"E":205000,"I":0.00011,"A":0.005245,"Z":0.000638},{"i":5,"j":6,"E":205000,"I":0.00011,"A":0.005245,"Z":0.000638},{"i":7,"j":8,"E":205000,"I":0.00011,"A":0.005245,"Z":0.000638},{"i":9,"j":10,"E":205000,"I":0.00011,"A":0.005245,"Z":0.000638},{"i":11,"j":12,"E":205000,"I":0.00011,"A":0.005245,"Z":0.000638}]}

       **5å±¤ãƒ©ãƒ¼ãƒ¡ãƒ³(ã‚¹ãƒ‘ãƒ³8m):**
       {"nodes":[{"x":0,"y":0,"s":"x"},{"x":8,"y":0,"s":"x"},{"x":0,"y":3,"s":"f"},{"x":8,"y":3,"s":"f"},{"x":0,"y":6,"s":"f"},{"x":8,"y":6,"s":"f"},{"x":0,"y":9,"s":"f"},{"x":8,"y":9,"s":"f"},{"x":0,"y":12,"s":"f"},{"x":8,"y":12,"s":"f"},{"x":0,"y":15,"s":"f"},{"x":8,"y":15,"s":"f"}],"members":[{"i":1,"j":3,"E":205000,"I":0.00011,"A":0.005245,"Z":0.000638},{"i":2,"j":4,"E":205000,"I":0.00011,"A":0.005245,"Z":0.000638},{"i":3,"j":5,"E":205000,"I":0.00011,"A":0.005245,"Z":0.000638},{"i":4,"j":6,"E":205000,"I":0.00011,"A":0.005245,"Z":0.000638},{"i":5,"j":7,"E":205000,"I":0.00011,"A":0.005245,"Z":0.000638},{"i":6,"j":8,"E":205000,"I":0.00011,"A":0.005245,"Z":0.000638},{"i":7,"j":9,"E":205000,"I":0.00011,"A":0.005245,"Z":0.000638},{"i":8,"j":10,"E":205000,"I":0.00011,"A":0.005245,"Z":0.000638},{"i":9,"j":11,"E":205000,"I":0.00011,"A":0.005245,"Z":0.000638},{"i":10,"j":12,"E":205000,"I":0.00011,"A":0.005245,"Z":0.000638},{"i":3,"j":4,"E":205000,"I":0.00011,"A":0.005245,"Z":0.000638},{"i":5,"j":6,"E":205000,"I":0.00011,"A":0.005245,"Z":0.000638},{"i":7,"j":8,"E":205000,"I":0.00011,"A":0.005245,"Z":0.000638},{"i":9,"j":10,"E":205000,"I":0.00011,"A":0.005245,"Z":0.000638},{"i":11,"j":12,"E":205000,"I":0.00011,"A":0.005245,"Z":0.000638}]}

       **5å±¤2ã‚¹ãƒ‘ãƒ³ã®ãƒ©ãƒ¼ãƒ¡ãƒ³(3åˆ—æŸ±):**
       {"nodes":[{"x":0,"y":0,"s":"x"},{"x":6,"y":0,"s":"x"},{"x":12,"y":0,"s":"x"},{"x":0,"y":3,"s":"f"},{"x":6,"y":3,"s":"f"},{"x":12,"y":3,"s":"f"},{"x":0,"y":6,"s":"f"},{"x":6,"y":6,"s":"f"},{"x":12,"y":6,"s":"f"},{"x":0,"y":9,"s":"f"},{"x":6,"y":9,"s":"f"},{"x":12,"y":9,"s":"f"},{"x":0,"y":12,"s":"f"},{"x":6,"y":12,"s":"f"},{"x":12,"y":12,"s":"f"},{"x":0,"y":15,"s":"f"},{"x":6,"y":15,"s":"f"},{"x":12,"y":15,"s":"f"}],"members":[{"i":1,"j":4,"E":205000,"I":0.00011,"A":0.005245,"Z":0.000638},{"i":2,"j":5,"E":205000,"I":0.00011,"A":0.005245,"Z":0.000638},{"i":3,"j":6,"E":205000,"I":0.00011,"A":0.005245,"Z":0.000638},{"i":4,"j":7,"E":205000,"I":0.00011,"A":0.005245,"Z":0.000638},{"i":5,"j":8,"E":205000,"I":0.00011,"A":0.005245,"Z":0.000638},{"i":6,"j":9,"E":205000,"I":0.00011,"A":0.005245,"Z":0.000638},{"i":7,"j":10,"E":205000,"I":0.00011,"A":0.005245,"Z":0.000638},{"i":8,"j":11,"E":205000,"I":0.00011,"A":0.005245,"Z":0.000638},{"i":9,"j":12,"E":205000,"I":0.00011,"A":0.005245,"Z":0.000638},{"i":10,"j":13,"E":205000,"I":0.00011,"A":0.005245,"Z":0.000638},{"i":11,"j":14,"E":205000,"I":0.00011,"A":0.005245,"Z":0.000638},{"i":12,"j":15,"E":205000,"I":0.00011,"A":0.005245,"Z":0.000638},{"i":13,"j":16,"E":205000,"I":0.00011,"A":0.005245,"Z":0.000638},{"i":14,"j":17,"E":205000,"I":0.00011,"A":0.005245,"Z":0.000638},{"i":15,"j":18,"E":205000,"I":0.00011,"A":0.005245,"Z":0.000638},{"i":4,"j":5,"E":205000,"I":0.00011,"A":0.005245,"Z":0.000638},{"i":5,"j":6,"E":205000,"I":0.00011,"A":0.005245,"Z":0.000638},{"i":7,"j":8,"E":205000,"I":0.00011,"A":0.005245,"Z":0.000638},{"i":8,"j":9,"E":205000,"I":0.00011,"A":0.005245,"Z":0.000638},{"i":10,"j":11,"E":205000,"I":0.00011,"A":0.005245,"Z":0.000638},{"i":11,"j":12,"E":205000,"I":0.00011,"A":0.005245,"Z":0.000638},{"i":13,"j":14,"E":205000,"I":0.00011,"A":0.005245,"Z":0.000638},{"i":14,"j":15,"E":205000,"I":0.00011,"A":0.005245,"Z":0.000638},{"i":16,"j":17,"E":205000,"I":0.00011,"A":0.005245,"Z":0.000638},{"i":17,"j":18,"E":205000,"I":0.00011,"A":0.005245,"Z":0.000638}]}

       **é‡è¦: 2ã‚¹ãƒ‘ãƒ³æ§‹é€ ã¯3åˆ—ã®æŸ±ãŒå¿…è¦ï¼ˆå·¦ç«¯ã€ä¸­å¤®ã€å³ç«¯ï¼‰**

       **ãƒ«ãƒ¼ãƒ«:**
       - ç¯€ç‚¹: x,yåº§æ¨™(m), s=å¢ƒç•Œæ¡ä»¶(f=è‡ªç”±,p=ãƒ”ãƒ³,r=ãƒ­ãƒ¼ãƒ©ãƒ¼,x=å›ºå®š)
       - éƒ¨æ: i,j=ç¯€ç‚¹ç•ªå·(1ã‹ã‚‰), E=205000, I=0.00011, A=0.005245, Z=0.000638
       - åº§æ¨™ç³»: å³=+X, ä¸Š=+Y
       - ç¯€ç‚¹ç•ªå·ã¯1ã‹ã‚‰å§‹ã¾ã‚‹é€£ç•ª
       - å­˜åœ¨ã™ã‚‹ç¯€ç‚¹ã®ã¿å‚ç…§
       - æŸ±è„š(Y=0)ã¯é€šå¸¸"x"(å›ºå®š)
       - ã‚¹ãƒ‘ãƒ³6-10m, é«˜ã•3-6mãŒä¸€èˆ¬çš„
       - å±¤æ•°æŒ‡å®šæ™‚ã¯å„å±¤3mé–“éš”ã§é…ç½®
       - å¿…ãšå®Œå…¨ãªJSONã‚’å‡ºåŠ›ã—ã€æœ€å¾Œã«}ã§çµ‚äº†ã™ã‚‹ã“ã¨
       - è¤‡é›‘ãªæ§‹é€ ã§ã‚‚å¿…ãšå…¨ã¦ã®éƒ¨æã‚’å«ã‚ã‚‹ã“ã¨
       - JSONã®æ§‹æ–‡ã‚¨ãƒ©ãƒ¼ã‚’é¿ã‘ã‚‹ãŸã‚ã€ã‚«ãƒ³ãƒã¨æ‹¬å¼§ã«æ³¨æ„ã™ã‚‹ã“ã¨`;

           if (mode === 'edit' && currentModel) {
               prompt += `\n\nç¾åœ¨ã®ãƒ¢ãƒ‡ãƒ«: ç¯€ç‚¹${currentModel.nodes?.length || 0}å€‹, éƒ¨æ${currentModel.members?.length || 0}å€‹`;
               prompt += `\n\n**ç·¨é›†æ™‚ã®æ³¨æ„äº‹é …:**
- æ—¢å­˜ã®æ§‹é€ å®‰å®šæ€§ã‚’ç¶­æŒã™ã‚‹ã“ã¨
- æŸ±è„š(Y=0)ã®ç¯€ç‚¹ã¯å¿…ãš"x"(å›ºå®š)ã«ã™ã‚‹ã“ã¨
- ç·¨é›†å¾Œã‚‚æ§‹é€ çš„ã«å®‰å®šãªãƒ¢ãƒ‡ãƒ«ã«ãªã‚‹ã“ã¨
- éƒ¨æã®æ¥ç¶šæ€§ã‚’ä¿æŒã™ã‚‹ã“ã¨
- ã‚¹ãƒ‘ãƒ³å¤‰æ›´æ™‚ã¯æ—¢å­˜ã®å±¤æ§‹é€ ã‚’ç¶­æŒã™ã‚‹ã“ã¨`;
           }

           return prompt;
}

// â–¼â–¼â–¼ ä»¥ä¸‹ã€æ—¢å­˜ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç”Ÿæˆé–¢æ•° (å¤‰æ›´ãªã—) â–¼â–¼â–¼

function createSystemPromptForBackend(mode = 'new', currentModel = null) {
    let prompt = `
ã‚ãªãŸã¯2Dãƒ•ãƒ¬ãƒ¼ãƒ æ§‹é€ è§£æãƒ¢ãƒ‡ãƒ«ã‚’ç”Ÿæˆã™ã‚‹å°‚é–€ã®ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã§ã™ã€‚`;

    if (mode === 'edit') {
        prompt += `
ç¾åœ¨ã®ãƒ¢ãƒ‡ãƒ«æƒ…å ±ã‚’åŸºã«ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ç·¨é›†æŒ‡ç¤ºã«å¾“ã£ã¦ãƒ¢ãƒ‡ãƒ«ã‚’æ›´æ–°ã—ã¦ãã ã•ã„ã€‚
æ—¢å­˜ã®æ§‹é€ ã‚’ä¿æŒã—ã¤ã¤ã€æŒ‡ç¤ºã•ã‚ŒãŸå¤‰æ›´ã®ã¿ã‚’é©ç”¨ã—ã¦ãã ã•ã„ã€‚`;
    } else {
        prompt += `
ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰ã®è‡ªç„¶è¨€èªã«ã‚ˆã‚‹æŒ‡ç¤ºã«åŸºã¥ã„ã¦ã€æ–°ã—ã„æ§‹é€ ãƒ¢ãƒ‡ãƒ«ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚`;
    }

    prompt += `
ä»¥ä¸‹ã®JSONå½¢å¼ã§æ§‹é€ ãƒ¢ãƒ‡ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚
JSONãƒ‡ãƒ¼ã‚¿ã®ã¿ã‚’å‡ºåŠ›ã—ã€å‰å¾Œã®èª¬æ˜ã‚„ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³ã®\`\`\`json ... \`\`\`ã¯å«ã‚ãªã„ã§ãã ã•ã„ã€‚

**JSONãƒ‡ãƒ¼ã‚¿æ§‹é€ ã®ä¾‹:**

**å˜ç´”ãª2ç¯€ç‚¹æ§‹é€ :**
\`\`\`json
{
  "nodes": [
    {"x": 0, "y": 0, "s": "x"},
    {"x": 8, "y": 0, "s": "x"}
  ],
  "members": [
    {"i": 1, "j": 2, "E": 205000, "I": 0.00011, "A": 0.005245, "Z": 0.000638}
  ]
}
\`\`\`

**2å±¤2ã‚¹ãƒ‘ãƒ³ãƒ©ãƒ¼ãƒ¡ãƒ³æ§‹é€ ã®ä¾‹:**
\`\`\`json
{
  "nodes": [
    {"x": 0, "y": 0, "s": "x"},
    {"x": 6, "y": 0, "s": "x"},
    {"x": 0, "y": 4, "s": "f"},
    {"x": 6, "y": 4, "s": "f"}
  ],
  "members": [
    {"i": 1, "j": 3, "E": 205000, "I": 0.00011, "A": 0.005245, "Z": 0.000638},
    {"i": 2, "j": 4, "E": 205000, "I": 0.00011, "A": 0.005245, "Z": 0.000638},
    {"i": 3, "j": 4, "E": 205000, "I": 0.00011, "A": 0.005245, "Z": 0.000638}
  ]
}
\`\`\`

**å„ã‚­ãƒ¼ã®è©³ç´°èª¬æ˜:**
- **nodes**: ç¯€ç‚¹ã®é…åˆ—
  - \`x\`: Xåº§æ¨™ (å˜ä½: m)
  - \`y\`: Yåº§æ¨™ (å˜ä½: m)
  - \`s\`: å¢ƒç•Œæ¡ä»¶ã€‚æ–‡å­—åˆ—ã§ "f" (è‡ªç”±), "p" (ãƒ”ãƒ³), "r" (ãƒ­ãƒ¼ãƒ©ãƒ¼), "x" (å›ºå®š) ã®ã„ãšã‚Œã‹ã€‚
- **members**: éƒ¨æã®é…åˆ—
  - \`i\`, \`j\`: å§‹ç‚¹ã¨çµ‚ç‚¹ã®ç¯€ç‚¹ç•ªå· (1ã‹ã‚‰å§‹ã¾ã‚‹æ•´æ•°)ã€‚
  - \`E\`: ãƒ¤ãƒ³ã‚°ä¿‚æ•° (å˜ä½: N/mmÂ²)ã€‚æŒ‡å®šãŒãªã‘ã‚Œã°é‹¼æã® \`205000\` ã‚’ä½¿ç”¨ã€‚
  - \`A\`: æ–­é¢ç© (å˜ä½: mÂ²)ã€‚
  - \`I\`: æ–­é¢äºŒæ¬¡ãƒ¢ãƒ¼ãƒ¡ãƒ³ãƒˆ (å˜ä½: mâ´)ã€‚
  - \`Z\`: æ–­é¢ä¿‚æ•° (å˜ä½: mÂ³)ã€‚
  - \`i_conn\`, \`j_conn\`: æ¥åˆæ¡ä»¶ã€‚"rigid" (å‰›æ¥åˆ) ã¾ãŸã¯ "pinned" (ãƒ”ãƒ³æ¥åˆ)ã€‚æŒ‡å®šãŒãªã‘ã‚Œã° "rigid" ã¨ã™ã‚‹ã€‚
  - **é‡è¦**: éƒ¨æã¯é…åˆ—ã®é †åºã§è­˜åˆ¥ã•ã‚Œã¾ã™ã€‚1ç•ªç›®ã®éƒ¨æã€2ç•ªç›®ã®éƒ¨æã¨ã—ã¦æ‰±ã‚ã‚Œã¾ã™ã€‚
- **nl**: ç¯€ç‚¹è·é‡ã®é…åˆ— (ã‚ªãƒ—ã‚·ãƒ§ãƒ³)
  - \`n\`: è·é‡ãŒã‹ã‹ã‚‹ç¯€ç‚¹ç•ªå· (1ã‹ã‚‰å§‹ã¾ã‚‹æ•´æ•°)ã€‚
  - \`px\`: Xæ–¹å‘è·é‡ (å˜ä½: kN)ã€‚å³å‘ããŒæ­£ã€‚
  - \`py\`: Yæ–¹å‘è·é‡ (å˜ä½: kN)ã€‚ä¸Šå‘ããŒæ­£ã€‚
  - \`mz\`: ãƒ¢ãƒ¼ãƒ¡ãƒ³ãƒˆè·é‡ (å˜ä½: kNãƒ»m)ã€‚åæ™‚è¨ˆå›ã‚ŠãŒæ­£ã€‚
- **ml**: éƒ¨æè·é‡ã®é…åˆ— (ã‚ªãƒ—ã‚·ãƒ§ãƒ³)
  - \`m\`: è·é‡ãŒã‹ã‹ã‚‹éƒ¨æç•ªå· (1ã‹ã‚‰å§‹ã¾ã‚‹æ•´æ•°)ã€‚
  - \`w\`: éƒ¨æåº§æ¨™ç³»yè»¸æ–¹å‘ã®ç­‰åˆ†å¸ƒè·é‡ (å˜ä½: kN/m)ã€‚éƒ¨æã®ä¸Šã‹ã‚‰ä¸‹å‘ãã«ã‹ã‹ã‚‹å ´åˆã¯æ­£ã®å€¤ã€‚

**é‡è¦ãªãƒ«ãƒ¼ãƒ«:**
- åº§æ¨™ç³»ã¯ã€å³æ–¹å‘ãŒXè»¸ã®æ­£ã€ä¸Šæ–¹å‘ãŒYè»¸ã®æ­£ã§ã™ã€‚
- è·é‡ã®å‘ãã«æ³¨æ„ã—ã¦ãã ã•ã„ã€‚ã€Œä¸‹å‘ãã€ã®é‰›ç›´è·é‡ã¯ \`py\` ãŒè² ã®å€¤ã«ãªã‚Šã¾ã™ã€‚
- éƒ¨æã®æ–­é¢æ€§èƒ½å€¤ (\`A\`, \`I\`, \`Z\`) ãŒä¸æ˜ãªå ´åˆã¯ã€ä¸€èˆ¬çš„ãªé‹¼ææ–­é¢ï¼ˆä¾‹ï¼šH-300x150x6.5x9ï¼‰ã®å€¤ã‚’ä»®å®šã—ã¦è¨­å®šã—ã¦ãã ã•ã„ (A=0.004678, I=0.0000721, Z=0.000481)ã€‚
- ç¯€ç‚¹ç•ªå·ã¨éƒ¨æç•ªå·ã¯1ã‹ã‚‰å§‹ã¾ã‚‹é€£ç•ªã§ã™ã€‚
- å­˜åœ¨ã—ãªã„ç¯€ç‚¹ç•ªå·ã‚„éƒ¨æç•ªå·ã‚’å‚ç…§ã—ãªã„ã§ãã ã•ã„ã€‚
- **ç¯€ç‚¹ç•ªå·ã¨éƒ¨æå‚ç…§ã®é‡è¦ãƒ«ãƒ¼ãƒ«:**
  - ç¯€ç‚¹ã¯é…åˆ—ã®é †åºï¼ˆ1ã‹ã‚‰å§‹ã¾ã‚‹ï¼‰ã§æ±ºã¾ã‚Šã¾ã™
  - éƒ¨æã®\`i\`ã¨\`j\`ã¯å¿…ãšå­˜åœ¨ã™ã‚‹ç¯€ç‚¹ç•ªå·ã‚’å‚ç…§ã—ã¦ãã ã•ã„
  - ä¾‹: ç¯€ç‚¹é…åˆ—ã«3ã¤ã®ç¯€ç‚¹ãŒã‚ã‚‹å ´åˆã€éƒ¨æã¯ç¯€ç‚¹1ã€2ã€3ã®ã¿ã‚’å‚ç…§ã§ãã¾ã™
  - è¤‡æ•°å±¤ã®æ§‹é€ ã§ã¯ã€ä¸‹å±¤ã‹ã‚‰ä¸Šå±¤ã¸é †åºè‰¯ãç¯€ç‚¹ã‚’é…ç½®ã—ã¦ãã ã•ã„
  - ãƒ©ãƒ¼ãƒ¡ãƒ³æ§‹é€ ã§ã¯ã€æŸ±ã¨æ¢ã®æ¥ç¶šç‚¹ãŒæ­£ç¢ºã«ä¸€è‡´ã™ã‚‹ã‚ˆã†ã«ç¯€ç‚¹ç•ªå·ã‚’è¨­å®šã—ã¦ãã ã•ã„
  - **è¤‡æ•°å±¤ãƒ©ãƒ¼ãƒ¡ãƒ³æ§‹é€ ã®ç”Ÿæˆãƒ«ãƒ¼ãƒ«:**
    - å„å±¤ã®æŸ±ã¯å‚ç›´ã«ä¸¦ã¹ã€åŒã˜Xåº§æ¨™ã«é…ç½®ã—ã¦ãã ã•ã„
    - æ¢ã¯å„å±¤ã®æŸ±é–“ã‚’æ°´å¹³ã«æ¥ç¶šã—ã¦ãã ã•ã„
    - ç¯€ç‚¹ç•ªå·ã¯ä¸‹å±¤ã‹ã‚‰ä¸Šå±¤ã¸ã€å·¦ã‹ã‚‰å³ã¸é †åºè‰¯ãä»˜ã‘ã¦ãã ã•ã„
    - ä¾‹: 2å±¤2ã‚¹ãƒ‘ãƒ³ã®å ´åˆã€1å±¤å·¦æŸ±=1ã€1å±¤å³æŸ±=2ã€2å±¤å·¦æŸ±=3ã€2å±¤å³æŸ±=4
- **æŸ±è„šã®å¢ƒç•Œæ¡ä»¶ã«é–¢ã™ã‚‹é‡è¦ãªãƒ«ãƒ¼ãƒ«:**
  - Yåº§æ¨™ãŒ0ã®ç¯€ç‚¹ï¼ˆåœ°é¢ã«æ¥ã™ã‚‹ç¯€ç‚¹ï¼‰ã¯æŸ±è„šã¨ã—ã¦æ‰±ã„ã¾ã™ã€‚
  - ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æŒ‡ç¤ºã§ã€ŒæŸ±è„šã¯å›ºå®šã€ã€ŒåŸºç¤ã¯å›ºå®šã€ã€Œæ”¯ç‚¹ã¯å›ºå®šã€ãªã©ã®è¨˜è¿°ãŒã‚ã‚‹å ´åˆã€Yåº§æ¨™=0ã®ç¯€ç‚¹ã®å¢ƒç•Œæ¡ä»¶ã‚’ "x" (å›ºå®š) ã«è¨­å®šã—ã¦ãã ã•ã„ã€‚
  - ã€ŒæŸ±è„šã¯ãƒ”ãƒ³ã€ã€ŒåŸºç¤ã¯ãƒ”ãƒ³ã€ã€Œæ”¯ç‚¹ã¯ãƒ”ãƒ³ã€ãªã©ã®è¨˜è¿°ãŒã‚ã‚‹å ´åˆã€Yåº§æ¨™=0ã®ç¯€ç‚¹ã®å¢ƒç•Œæ¡ä»¶ã‚’ "p" (ãƒ”ãƒ³) ã«è¨­å®šã—ã¦ãã ã•ã„ã€‚
  - ã€ŒæŸ±è„šã¯ãƒ­ãƒ¼ãƒ©ãƒ¼ã€ã€ŒåŸºç¤ã¯ãƒ­ãƒ¼ãƒ©ãƒ¼ã€ã€Œæ”¯ç‚¹ã¯ãƒ­ãƒ¼ãƒ©ãƒ¼ã€ãªã©ã®è¨˜è¿°ãŒã‚ã‚‹å ´åˆã€Yåº§æ¨™=0ã®ç¯€ç‚¹ã®å¢ƒç•Œæ¡ä»¶ã‚’ "r" (ãƒ­ãƒ¼ãƒ©ãƒ¼) ã«è¨­å®šã—ã¦ãã ã•ã„ã€‚
  - æŸ±è„šã«é–¢ã™ã‚‹æ˜ç¤ºçš„ãªæŒ‡ç¤ºãŒãªã„å ´åˆã§ã‚‚ã€ä¸€èˆ¬çš„ãªæ§‹é€ ã§ã¯æŸ±è„šã¯å›ºå®šã¨ã™ã‚‹ã®ãŒåˆç†çš„ã§ã™ã€‚ç‰¹ã«ã€Œé–€å‹ãƒ©ãƒ¼ãƒ¡ãƒ³ã€ã€Œãƒ•ãƒ¬ãƒ¼ãƒ ã€ã€Œãƒ©ãƒ¼ãƒ¡ãƒ³æ§‹é€ ã€ãªã©ã®è¨˜è¿°ãŒã‚ã‚‹å ´åˆã¯ã€Yåº§æ¨™=0ã®ç¯€ç‚¹ã‚’ "x" (å›ºå®š) ã«è¨­å®šã—ã¦ãã ã•ã„ã€‚
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æŒ‡ç¤ºã«æ›–æ˜§ãªç‚¹ãŒã‚ã‚‹å ´åˆã¯ã€æœ€ã‚‚ä¸€èˆ¬çš„ã§åˆç†çš„ãªæ§‹é€ ã‚’ä»®å®šã—ã¦ãƒ¢ãƒ‡ãƒ«ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚
- **æ§‹é€ ç”Ÿæˆæ™‚ã®æ³¨æ„äº‹é …:**
  - ç¯€ç‚¹ç•ªå·ã¯é…åˆ—ã®é †åºï¼ˆ1ã‹ã‚‰å§‹ã¾ã‚‹ï¼‰ã§æ±ºã¾ã‚Šã¾ã™
  - éƒ¨æã®\`i\`ã¨\`j\`ã¯å¿…ãšå­˜åœ¨ã™ã‚‹ç¯€ç‚¹ç•ªå·ã‚’å‚ç…§ã—ã¦ãã ã•ã„
  - ãƒ©ãƒ¼ãƒ¡ãƒ³æ§‹é€ ã§ã¯ã€æŸ±ã¨æ¢ã®æ¥ç¶šãŒæ­£ç¢ºã«ãªã‚‹ã‚ˆã†ç¯€ç‚¹é…ç½®ã‚’ç¢ºèªã—ã¦ãã ã•ã„
  - è¤‡æ•°å±¤æ§‹é€ ã§ã¯ã€å„å±¤ã®é«˜ã•ã‚’é©åˆ‡ã«è¨­å®šã—ã¦ãã ã•ã„ï¼ˆä¾‹: 1å±¤=4mã€2å±¤=8mï¼‰
  - ã‚¹ãƒ‘ãƒ³é•·ã¯ä¸€èˆ¬çš„ãªå€¤ã‚’è¨­å®šã—ã¦ãã ã•ã„ï¼ˆä¾‹: 6mã€8mã€10mï¼‰
`;

    if (mode === 'edit' && currentModel) {
        prompt += `

**ç¾åœ¨ã®ãƒ¢ãƒ‡ãƒ«æƒ…å ±:**
ç¯€ç‚¹æ•°: ${currentModel.nodes ? currentModel.nodes.length : 0}
éƒ¨ææ•°: ${currentModel.members ? currentModel.members.length : 0}
ç¯€ç‚¹è·é‡æ•°: ${currentModel.nodeLoads ? currentModel.nodeLoads.length : 0}
éƒ¨æè·é‡æ•°: ${currentModel.memberLoads ? currentModel.memberLoads.length : 0}

ç·¨é›†æ™‚ã¯ä»¥ä¸‹ã®ç‚¹ã«æ³¨æ„ã—ã¦ãã ã•ã„:
- æ—¢å­˜ã®ç¯€ç‚¹ç•ªå·ã¨éƒ¨æç•ªå·ã®é€£ç¶šæ€§ã‚’ä¿æŒã—ã¦ãã ã•ã„
- æ—¢å­˜ã®æ§‹é€ ã®åŸºæœ¬å½¢çŠ¶ã¯ç¶­æŒã—ã€æŒ‡ç¤ºã•ã‚ŒãŸå¤‰æ›´ã®ã¿ã‚’é©ç”¨ã—ã¦ãã ã•ã„
- æ–°ã—ãè¿½åŠ ã™ã‚‹ç¯€ç‚¹ã‚„éƒ¨æã¯ã€æ—¢å­˜ã®ç•ªå·ã®ç¶šãã‹ã‚‰é–‹å§‹ã—ã¦ãã ã•ã„
- å‰Šé™¤ã™ã‚‹å ´åˆã¯ã€å¾Œç¶šã®ç•ªå·ã‚’è©°ã‚ã‚‹å¿…è¦ã¯ã‚ã‚Šã¾ã›ã‚“
- **ç¯€ç‚¹ã®åº§æ¨™å¤‰æ›´ã®å ´åˆ**:
  - ã€Œã‚¹ãƒ‘ãƒ³ã‚’â—‹mã«å¤‰æ›´ã€ã€Œæ¢ã®é•·ã•ã‚’â—‹mã«å¤‰æ›´ã€ãªã©ã®æŒ‡ç¤ºã§ã¯ã€æ—¢å­˜ã®ç¯€ç‚¹ã®åº§æ¨™ã‚’å¤‰æ›´ã—ã¦ãã ã•ã„
  - æ—¢å­˜ã®ç¯€ç‚¹ã®åº§æ¨™ï¼ˆx, yï¼‰ã‚’æ–°ã—ã„åº§æ¨™ã«å¤‰æ›´ã™ã‚‹ã“ã¨ã§ã€æ§‹é€ ã®å½¢çŠ¶ã‚’ä¿®æ­£ã§ãã¾ã™
  - æ—¢å­˜ã®ç¯€ç‚¹ã‚’ä¿®æ­£ã™ã‚‹å ´åˆã¯ã€åŒã˜é…åˆ—ä½ç½®ã§ç¯€ç‚¹ãƒ‡ãƒ¼ã‚¿ã‚’å‡ºåŠ›ã—ã¦ãã ã•ã„
  - ä¾‹: 1ç•ªç›®ã®ç¯€ç‚¹ã®åº§æ¨™ã‚’å¤‰æ›´ã™ã‚‹å ´åˆã€nodesé…åˆ—ã®1ç•ªç›®ã¨ã—ã¦æ–°ã—ã„åº§æ¨™ã‚’æŒã¤ãƒ‡ãƒ¼ã‚¿ã‚’å‡ºåŠ›ã—ã¦ãã ã•ã„
- **éƒ¨æã®é•·ã•å¤‰æ›´ã‚„ä½ç½®å¤‰æ›´ã®å ´åˆ**:
  - ã€Œã‚¹ãƒ‘ãƒ³ã‚’â—‹mã«å¤‰æ›´ã€ã€Œæ¢ã®é•·ã•ã‚’â—‹mã«å¤‰æ›´ã€ãªã©ã®æŒ‡ç¤ºã§ã¯ã€æ—¢å­˜ã®éƒ¨æã®ç¯€ç‚¹ç•ªå·ã‚’å¤‰æ›´ã—ã¦é•·ã•ã‚’èª¿æ•´ã—ã¦ãã ã•ã„
  - æ—¢å­˜ã®éƒ¨æã®ç¯€ç‚¹ç•ªå·ï¼ˆi, jï¼‰ã‚’æ–°ã—ã„åº§æ¨™ã®ç¯€ç‚¹ã«å¤‰æ›´ã™ã‚‹ã“ã¨ã§ã€éƒ¨æã®é•·ã•ã‚„ä½ç½®ã‚’ä¿®æ­£ã§ãã¾ã™
  - å¿…è¦ã«å¿œã˜ã¦æ–°ã—ã„ç¯€ç‚¹ã‚’è¿½åŠ ã—ã€æ—¢å­˜éƒ¨æã®æ¥ç¶šå…ˆã‚’å¤‰æ›´ã—ã¦ãã ã•ã„
  - **é‡è¦**: æ—¢å­˜ã®éƒ¨æã‚’ä¿®æ­£ã™ã‚‹å ´åˆã¯ã€åŒã˜é…åˆ—ä½ç½®ã§éƒ¨æãƒ‡ãƒ¼ã‚¿ã‚’å‡ºåŠ›ã—ã¦ãã ã•ã„
  - ä¾‹: æ—¢å­˜ã®1ç•ªç›®ã®éƒ¨æãŒç¯€ç‚¹1â†’2ã§ã€ã“ã‚Œã‚’ç¯€ç‚¹1â†’3ã«å¤‰æ›´ã™ã‚‹å ´åˆã€membersé…åˆ—ã®1ç•ªç›®ã¨ã—ã¦ç¯€ç‚¹1â†’3ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‡ºåŠ›ã—ã¦ãã ã•ã„
`;
    }

    return prompt;
}

function createEditPrompt(userPrompt, currentModel) {
    let editPrompt = `ç·¨é›†æŒ‡ç¤º: ${userPrompt}\n\n`;
    
    if (currentModel && currentModel.nodes && currentModel.nodes.length > 0) {
        editPrompt += `ç¾åœ¨ã®ç¯€ç‚¹æƒ…å ±:\n`;
        currentModel.nodes.forEach((node, index) => {
            const supportText = {
                'free': 'è‡ªç”±',
                'pinned': 'ãƒ”ãƒ³', 
                'fixed': 'å›ºå®š',
                'roller': 'ãƒ­ãƒ¼ãƒ©ãƒ¼'
            }[node.s] || node.s;
            editPrompt += `ç¯€ç‚¹${index + 1}: (${node.x}, ${node.y}) - ${supportText}\n`;
        });
        editPrompt += `\n`;
        
        editPrompt += `ç¯€ç‚¹ä¿®æ­£æ™‚ã®æ³¨æ„äº‹é …:\n`;
        editPrompt += `- æ—¢å­˜ã®ç¯€ç‚¹ã‚’ä¿®æ­£ã™ã‚‹å ´åˆã¯ã€åŒã˜é…åˆ—ä½ç½®ï¼ˆ1ç•ªç›®ã€2ç•ªç›®ãªã©ï¼‰ã§å‡ºåŠ›ã—ã¦ãã ã•ã„\n`;
        editPrompt += `- åº§æ¨™ï¼ˆx, yï¼‰ã‚’å¤‰æ›´ã™ã‚‹ã“ã¨ã§ç¯€ç‚¹ã®ä½ç½®ã‚’ä¿®æ­£ã§ãã¾ã™\n`;
        editPrompt += `- ä¾‹: 1ç•ªç›®ã®ç¯€ç‚¹ã®åº§æ¨™ã‚’å¤‰æ›´ã™ã‚‹å ´åˆã€nodesé…åˆ—ã®1ç•ªç›®ã¨ã—ã¦æ–°ã—ã„åº§æ¨™ã‚’æŒã¤ãƒ‡ãƒ¼ã‚¿ã‚’å‡ºåŠ›ã—ã¦ãã ã•ã„\n`;
        editPrompt += `- æ—¢å­˜ã®ç¯€ç‚¹ã‚’å‰Šé™¤ã™ã‚‹å ´åˆã¯ã€ãã®ç¯€ç‚¹ã‚’å‡ºåŠ›ã—ãªã„ã§ãã ã•ã„\n`;
        editPrompt += `\n`;
    }
    
    if (currentModel && currentModel.members && currentModel.members.length > 0) {
        editPrompt += `ç¾åœ¨ã®éƒ¨ææƒ…å ±:\n`;
        currentModel.members.forEach((member, index) => {
            const length = member.length ? ` (é•·ã•: ${member.length.toFixed(2)}m)` : '';
            const section = member.sectionName ? ` (æ–­é¢: ${member.sectionName})` : '';
            editPrompt += `éƒ¨æ${index + 1}: ç¯€ç‚¹${member.i} â†’ ç¯€ç‚¹${member.j}${length}${section}\n`;
        });
        editPrompt += `\n`;
        
        editPrompt += `éƒ¨æä¿®æ­£æ™‚ã®æ³¨æ„äº‹é …:\n`;
        editPrompt += `- æ—¢å­˜ã®éƒ¨æã‚’ä¿®æ­£ã™ã‚‹å ´åˆã¯ã€åŒã˜é…åˆ—ä½ç½®ï¼ˆ1ç•ªç›®ã€2ç•ªç›®ãªã©ï¼‰ã§å‡ºåŠ›ã—ã¦ãã ã•ã„\n`;
        editPrompt += `- ç¯€ç‚¹ç•ªå·ï¼ˆi, jï¼‰ã‚’å¤‰æ›´ã™ã‚‹ã“ã¨ã§éƒ¨æã®é•·ã•ã‚„ä½ç½®ã‚’ä¿®æ­£ã§ãã¾ã™\n`;
        editPrompt += `- ä¾‹: 1ç•ªç›®ã®éƒ¨æã®é•·ã•ã‚’å¤‰æ›´ã™ã‚‹å ´åˆã€membersé…åˆ—ã®1ç•ªç›®ã¨ã—ã¦æ–°ã—ã„ç¯€ç‚¹ç•ªå·ã‚’æŒã¤ãƒ‡ãƒ¼ã‚¿ã‚’å‡ºåŠ›ã—ã¦ãã ã•ã„\n`;
        editPrompt += `- æ—¢å­˜ã®éƒ¨æã‚’å‰Šé™¤ã™ã‚‹å ´åˆã¯ã€ãã®éƒ¨æã‚’å‡ºåŠ›ã—ãªã„ã§ãã ã•ã„\n`;
        editPrompt += `\n`;
    }
    
    if (currentModel && currentModel.nodeLoads && currentModel.nodeLoads.length > 0) {
        editPrompt += `ç¾åœ¨ã®ç¯€ç‚¹è·é‡:\n`;
        currentModel.nodeLoads.forEach((load, index) => {
            editPrompt += `ç¯€ç‚¹${load.n}: Fx=${load.fx}, Fy=${load.fy}, Mz=${load.mz}\n`;
        });
        editPrompt += `\n`;
    }
    
    if (currentModel && currentModel.memberLoads && currentModel.memberLoads.length > 0) {
        editPrompt += `ç¾åœ¨ã®éƒ¨æè·é‡:\n`;
        currentModel.memberLoads.forEach((load, index) => {
            editPrompt += `éƒ¨æ${load.m}: ${load.type} ${load.magnitude} (ä½ç½®:${load.position})\n`;
        });
        editPrompt += `\n`;
    }
    
    editPrompt += `ä¸Šè¨˜ã®ç¾åœ¨ã®ãƒ¢ãƒ‡ãƒ«ã«å¯¾ã—ã¦ã€æŒ‡ç¤ºã•ã‚ŒãŸç·¨é›†ã‚’é©ç”¨ã—ã¦ãã ã•ã„ã€‚`;
    
    return editPrompt;
}